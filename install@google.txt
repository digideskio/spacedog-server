###
### Provision and install
###

# provision a server
gcloud compute instances create magic-server-1 --image debian-7 --zone europe-west1-d --machine-type g1-small --no-scopes

# copy jdk to server
gcloud compute copy-files server-jre-8u45-linux-x64.gz magic-server-1:~/bin --zone europe-west1-d

# set firewall rules
gcloud compute firewall-rules create allow-http --allow tcp:80 --log-http --project magic-apps --description "Accept inbound connections on ports 80 and 8080"
gcloud compute firewall-rules create allow-https --allow tcp:443 --log-http --project magic-apps --description "Accept inbound connections on ports 443"

# SSH server
gcloud compute ssh magic-server-1 --zone europe-west1-d


###
### Install JRE
###
### J'ai suivi --- je pense mais c'est pas s√ªr --- le tuto suivant
###
### https://www.digitalocean.com/community/tutorials/how-to-manually-install-oracle-java-on-a-debian-or-ubuntu-vps
###
###


###
### Build and deploy
###

# package the soft
mvn -DskipTests clean package

# clean server
# be careful to keep the magic/data folder
rm -r magic/libs
rm magic/*.sh
rm magiclabs-rest-api-0.1.0-SNAPSHOT-bundle.tar.gz

# copy release to server
gcloud compute copy-files target/magiclabs-rest-api-0.1.0-SNAPSHOT-bundle.tar.gz magic-server-1:~/install --zone europe-west1-d

# untar
tar xvzf install/magiclabs-rest-api-0.1.0-SNAPSHOT-bundle.tar.gz

# run
cd /magic
# sudo sinon permission denied
sudo ./start.sh


###
### For java server auto start at boot time, configure a custom metadata of the instance with
### key=startup-script value=/home/davattias/magic/start.sh
###
